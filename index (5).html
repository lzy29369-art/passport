<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>护照管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            .shadow-hover {
                @apply transition-all duration-300;
            }
            .shadow-hover:hover {
                @apply shadow-lg transform -translate-y-1;
            }
            .status-badge {
                @apply px-2 py-1 rounded-full text-xs font-medium;
            }
            .status-in-stock {
                @apply bg-green-100 text-green-800;
            }
            .status-business {
                @apply bg-yellow-100 text-yellow-800;
            }
            .status-personal {
                @apply bg-blue-100 text-blue-800;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="bg-dark text-white w-64 flex-shrink-0 hidden md:block">
            <div class="p-4 flex items-center justify-center border-b border-gray-700">
                <i class="fa fa-id-card-o text-2xl mr-2"></i>
                <h1 class="text-xl font-bold">护照管理系统</h1>
            </div>
            <nav class="mt-6">
                <ul>
                    <li>
                        <a href="#dashboard" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all nav-link active" data-target="dashboard">
                            <i class="fa fa-dashboard w-5"></i>
                            <span class="mx-3">数据概览</span>
                        </a>
                    </li>
                    <li>
                        <a href="#add-person" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all nav-link" data-target="add-person">
                            <i class="fa fa-user-plus w-5"></i>
                            <span class="mx-3">添加人员</span>
                        </a>
                    </li>
                    <li>
                        <a href="#manage-passport" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all nav-link" data-target="manage-passport">
                            <i class="fa fa-exchange w-5"></i>
                            <span class="mx-3">护照管理</span>
                        </a>
                    </li>
                    <li>
                        <a href="#history" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all nav-link" data-target="history">
                            <i class="fa fa-history w-5"></i>
                            <span class="mx-3">历史记录</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-700">
                <p class="text-sm text-gray-400">© 2025 护照管理系统</p>
            </div>
        </aside>

        <!-- 移动端侧边栏按钮 -->
        <div class="md:hidden fixed bottom-4 right-4 z-50">
            <button id="mobile-menu-button" class="bg-primary text-white p-3 rounded-full shadow-lg">
                <i class="fa fa-bars"></i>
            </button>
        </div>

        <!-- 移动端侧边栏 -->
        <div id="mobile-menu" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-40 hidden md:hidden">
            <div class="bg-dark text-white w-64 h-full overflow-y-auto transform transition-transform -translate-x-full" id="mobile-menu-content">
                <div class="p-4 flex items-center justify-between border-b border-gray-700">
                    <div class="flex items-center">
                        <i class="fa fa-id-card-o text-2xl mr-2"></i>
                        <h1 class="text-xl font-bold">护照管理系统</h1>
                    </div>
                    <button id="close-mobile-menu" class="text-gray-400 hover:text-white">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <nav class="mt-6">
                    <ul>
                        <li>
                            <a href="#dashboard" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all mobile-nav-link" data-target="dashboard">
                                <i class="fa fa-dashboard w-5"></i>
                                <span class="mx-3">数据概览</span>
                            </a>
                        </li>
                        <li>
                            <a href="#add-person" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all mobile-nav-link" data-target="add-person">
                                <i class="fa fa-user-plus w-5"></i>
                                <span class="mx-3">添加人员</span>
                            </a>
                        </li>
                        <li>
                            <a href="#manage-passport" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all mobile-nav-link" data-target="manage-passport">
                                <i class="fa fa-exchange w-5"></i>
                                <span class="mx-3">护照管理</span>
                            </a>
                        </li>
                        <li>
                            <a href="#history" class="flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 hover:text-white transition-all mobile-nav-link" data-target="history">
                                <i class="fa fa-history w-5"></i>
                                <span class="mx-3">历史记录</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部搜索栏 -->
            <header class="bg-white shadow-sm z-10">
                <div class="px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center md:hidden">
                        <h2 class="text-lg font-semibold text-gray-800" id="mobile-title">数据概览</h2>
                    </div>
                    <div class="flex-1 max-w-md mx-4">
                        <div class="flex items-center space-x-2">
                            <div class="relative flex-grow">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <i class="fa fa-search text-gray-400"></i>
                                </span>
                                <input type="text" id="search-input" placeholder="搜索姓名或工号..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <select id="items-per-page" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="5">5条/页</option>
                                    <option value="10" selected>10条/页</option>
                                    <option value="20">20条/页</option>
                                    <option value="50">50条/页</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <button id="export-data" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all flex items-center">
                            <i class="fa fa-download mr-2"></i>
                            导出数据
                        </button>
                    </div>
                </div>
            </header>

            <!-- 内容区域 -->
            <main class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <!-- 数据概览 -->
                <section id="dashboard" class="content-section active">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">数据概览</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- 卡片 1：总人数 -->
                            <div class="bg-white rounded-lg shadow p-4 shadow-hover">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                        <i class="fa fa-users fa-2x"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm text-gray-500">总人数</p>
                                        <p class="text-2xl font-semibold text-gray-800" id="total-persons">0</p>
                                    </div>
                                </div>
                            </div>
                            <!-- 卡片 2：在库中 -->
                            <div class="bg-white rounded-lg shadow p-4 shadow-hover cursor-pointer" onclick="filterByStatus('in-stock')">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                                        <i class="fa fa-check-circle fa-2x"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm text-gray-500">在库中</p>
                                        <p class="text-2xl font-semibold text-gray-800" id="in-stock-passports">0</p>
                                    </div>
                                </div>
                            </div>
                            <!-- 卡片 3：已领取 -->
                            <div class="bg-white rounded-lg shadow p-4 shadow-hover cursor-pointer" onclick="filterByStatus('personal')">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                                        <i class="fa fa-sign-out fa-2x"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm text-gray-500">已领取</p>
                                        <p class="text-2xl font-semibold text-gray-800" id="personal-passports">0</p>
                                    </div>
                                </div>
                            </div>
                            <!-- 卡片 4：业务办理 -->
                            <div class="bg-white rounded-lg shadow p-4 shadow-hover cursor-pointer" onclick="filterByStatus('business')">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                        <i class="fa fa-briefcase fa-2x"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm text-gray-500">业务办理</p>
                                        <p class="text-2xl font-semibold text-gray-800" id="business-passports">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- 图表：护照状态分布 -->
                        <div class="bg-white rounded-lg shadow p-4 lg:col-span-1 max-w-xs mx-auto">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">护照状态分布</h3>
                            <div class="h-64">
                                <canvas id="passport-status-chart"></canvas>
                            </div>
                        </div>

                        <!-- 表格：人员列表 -->
                        <div class="bg-white rounded-lg shadow p-4 lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">人员列表</h3>
                                <div class="flex items-center space-x-2">
                                    <button id="refresh-list-btn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300 flex items-center">
                                        <i class="fa fa-refresh mr-1"></i> 更新列表
                                    </button>
                                    <label for="status-filter" class="mr-2 text-sm text-gray-600">状态筛选：</label>
                                    <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="all">全部</option>
                                        <option value="business">全部业务办理</option>
                                        <option value="personal">全部本人领取</option>
                                        <option value="in-stock">全部在库中</option>

                                    </select>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">护照数量</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最近操作</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="person-table-body">
                                        <!-- 表格内容将由JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <p class="text-sm text-gray-500">显示 <span id="showing-records">0</span> 条记录</p>
                                <div class="flex space-x-2">
                                    <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">上一页</button>
                                    <button id="next-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">下一页</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 添加人员 -->
                <section id="add-person" class="content-section hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">添加人员</h2>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="mb-6 p-4 border-2 border-dashed border-gray-300 rounded-lg">
                                <div class="flex flex-col items-center justify-center">
                                    <i class="fa fa-file-excel-o text-4xl text-green-500 mb-2"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-1">批量导入人员</h3>
                                    <p class="text-sm text-gray-500 mb-3">上传Excel文件批量导入人员信息（仅支持姓名和护照号）</p>
                                    <label for="excel-file" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 cursor-pointer">
                                        <i class="fa fa-upload mr-1"></i> 选择文件
                                    </label>
                                    <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden">
                                    <p class="text-xs text-gray-400 mt-2">支持 .xlsx 和 .xls 格式，请确保第一列为工号，第二列为姓名，第三列为护照号，第四列为状态（可选，值为：in-stock, business, personal）</p>
                                </div>
                            </div>
                            <form id="add-person-form">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="person-name" class="block text-sm font-medium text-gray-700 mb-1">姓名 <span class="text-red-500">*</span></label>
                                        <input type="text" id="person-name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="person-job-id" class="block text-sm font-medium text-gray-700 mb-1">工号 <span class="text-red-500">*</span></label>
                                        <input type="text" id="person-job-id" name="jobId" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="person-id" class="block text-sm font-medium text-gray-700 mb-1">身份证号</label>
                                        <input type="text" id="person-id" name="idNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="person-phone" class="block text-sm font-medium text-gray-700 mb-1">电话</label>
                                        <input type="tel" id="person-phone" name="phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                    <div>
                                        <label for="person-email" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                                        <input type="email" id="person-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>

                                <div class="mt-6">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">护照信息</label>
                                    <div id="passport-container">
                                        <div class="passport-item border border-gray-200 rounded-lg p-4 mb-4">
                                            <div class="flex justify-between items-center mb-4">
                                                <h4 class="text-md font-medium text-gray-800">护照 1</h4>
                                                <button type="button" class="remove-passport text-red-500 hover:text-red-700" disabled>
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">护照号 <span class="text-red-500">*</span></label>
                                                    <input type="text" name="passportNumbers[]" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                                                    <input type="text" name="passportNotes[]" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" id="add-passport" class="mt-2 flex items-center text-primary hover:text-blue-700">
                                        <i class="fa fa-plus-circle mr-1"></i>
                                        添加护照
                                    </button>
                                </div>

                                <div class="mt-6">
                                    <label for="person-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                                    <textarea id="person-notes" name="notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                                </div>

                                <div class="mt-6 flex justify-end">
                                    <button type="button" id="cancel-add-person" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 mr-3">取消</button>
                                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- 护照管理 -->
                <section id="manage-passport" class="content-section hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">护照管理</h2>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row md:items-end gap-4">
                                    <div class="flex-1">
                                        <label for="manage-search" class="block text-sm font-medium text-gray-700 mb-1">搜索人员</label>
                                        <div class="relative">
                                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                                <i class="fa fa-search text-gray-400"></i>
                                            </span>
                                            <input type="text" id="manage-search" placeholder="输入姓名..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        </div>
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <button id="search-person-btn" class="w-full md:w-auto px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">搜索</button>
                                    </div>
                                </div>
                            </div>

                            <div id="manage-person-result" class="hidden">
                                <div class="border-b border-gray-200 pb-4 mb-4">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                                        <div>
                                            <h3 class="text-xl font-semibold text-gray-800" id="manage-person-name"></h3>
                                            <div class="flex flex-wrap gap-4 mt-1">
                                                <p class="text-sm text-gray-600"><span class="font-medium">工号：</span><span id="manage-person-id"></span></p>
                                                <p class="text-sm text-gray-600"><span class="font-medium">电话：</span><span id="manage-person-phone"></span></p>
                                                <p class="text-sm text-gray-600"><span class="font-medium">邮箱：</span><span id="manage-person-email"></span></p>
                                            </div>
                                        </div>
                                        <div class="mt-3 md:mt-0">
                                            <span class="status-badge" id="manage-person-status"></span>
                                        </div>
                                    </div>
                                </div>

                                <div id="passports-to-manage">
                                    <!-- 护照列表将由JavaScript动态生成 -->
                                </div>

                                <div class="mt-6 border-t border-gray-200 pt-4">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-3">操作记录</h4>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">护照号</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作人</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200" id="operation-history">
                                                <!-- 操作记录将由JavaScript动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div id="manage-person-list" class="mt-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">人员列表</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">护照数量</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最近操作</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="manage-person-table-body">
                                            <!-- 表格内容将由JavaScript动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <p class="text-sm text-gray-500">显示 <span id="manage-showing-records">0</span> 条记录</p>
                                    <div class="flex space-x-2">
                                        <button id="manage-prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">上一页</button>
                                        <button id="manage-next-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">下一页</button>
                                    </div>
                                </div>
                            </div>

                            <div id="manage-no-result" class="hidden text-center py-8">
                                <i class="fa fa-search text-gray-300 text-5xl mb-3"></i>
                                <p class="text-gray-500">请输入姓名搜索人员</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 历史记录 -->
                <section id="history" class="content-section hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">历史记录</h2>
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex flex-col md:flex-row md:items-center gap-4 mb-6">
                                <div class="flex-1">
                                    <label for="history-search" class="block text-sm font-medium text-gray-700 mb-1">搜索操作记录</label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                            <i class="fa fa-search text-gray-400"></i>
                                        </span>
                                        <input type="text" id="history-search" placeholder="输入姓名或护照号..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    </div>
                                </div>
                                <div>
                                    <label for="history-operation" class="block text-sm font-medium text-gray-700 mb-1">操作类型</label>
                                    <select id="history-operation" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="all">全部</option>
                                        <option value="add">添加人员</option>
                                        <option value="take">领取护照</option>
                                        <option value="return">归还护照</option>
                                        <option value="delete">删除护照</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="history-date-range" class="block text-sm font-medium text-gray-700 mb-1">日期范围</label>
                                    <select id="history-date-range" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                        <option value="7">最近7天</option>
                                        <option value="30" selected>最近30天</option>
                                        <option value="90">最近90天</option>
                                        <option value="all">全部</option>
                                    </select>
                                </div>
                                <div class="md:self-end">
                                    <button id="history-search-btn" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700">搜索</button>
                                </div>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作人</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作类型</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">相关人员</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">护照号</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="history-table-body">
                                        <!-- 历史记录将由JavaScript动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <p class="text-sm text-gray-500">显示 <span id="history-showing-records">0</span> 条记录</p>
                                <div class="flex space-x-2">
                                    <button id="history-prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">上一页</button>
                                    <button id="history-next-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm disabled:opacity-50">下一页</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 护照操作模态框 -->
    <div id="passport-action-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800" id="modal-title">护照操作</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="passport-action-form">
                    <input type="hidden" id="modal-person-id">
                    <input type="hidden" id="modal-passport-index">
                    <input type="hidden" id="modal-action-type">

                    <div class="mb-4">
                        <label for="modal-person-name" class="block text-sm font-medium text-gray-700 mb-1">人员</label>
                        <input type="text" id="modal-person-name" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <div class="mb-4">
                        <label for="modal-passport-number" class="block text-sm font-medium text-gray-700 mb-1">护照号</label>
                        <input type="text" id="modal-passport-number" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <!-- 状态选择（仅在从"在库中"状态操作时显示） -->
                    <div class="mb-4" id="modal-status-select-container">
                        <label for="modal-status-select" class="block text-sm font-medium text-gray-700 mb-1">选择状态</label>
                        <select id="modal-status-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="business">业务办理</option>
                            <option value="personal">本人领取</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="modal-action-time" class="block text-sm font-medium text-gray-700 mb-1">操作时间</label>
                        <input type="datetime-local" id="modal-action-time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label for="modal-operator" class="block text-sm font-medium text-gray-700 mb-1">操作人</label>
                        <input type="text" id="modal-operator" placeholder="可选" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label for="modal-notes" class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <textarea id="modal-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" id="cancel-modal" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 mr-3">取消</button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700" id="modal-submit-btn">确认</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-10 opacity-0 transition-all duration-300 z-50">
        <div class="flex items-center">
            <i class="fa fa-check-circle mr-2"></i>
            <span id="toast-message">操作成功</span>
        </div>
    </div>

    <script>
        // 数据存储
        let persons = [];
        let history = [];
        let currentPage = 1;
        let manageCurrentPage = 1;
        let itemsPerPage = 10;
        let historyPage = 1;
        let historyItemsPerPage = 10;
        let passportStatusChart = null;

        // DOM 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据
            initializeData();
            
            // 初始化图表
            initializeChart();
            
            // 更新统计数据
            updateStatistics();
            
            // 渲染人员表格
            renderPersonTable();
            
            // 渲染历史记录
            renderHistoryTable();
            
            // 导航切换
            setupNavigation();
            
            // 移动端菜单
            setupMobileMenu();
            
            // 表单事件
            setupForms();
            
            // 搜索事件
            setupSearch();
            
            // 分页事件
            setupPagination();
            
            // 模态框事件
            setupModal();
            
            // 导出数据
            setupExport();
        });

        // 初始化数据
        function initializeData() {
            // 从 localStorage 加载数据
            const savedPersons = localStorage.getItem('passportManagementPersons');
            const savedHistory = localStorage.getItem('passportManagementHistory');
            
            if (savedPersons) {
                persons = JSON.parse(savedPersons);
            } else {
                // 添加示例数据
                persons = [
                    {
                        id: generateId(),
                        name: '张三',
                        idNumber: '110101199001011234',
                        phone: '13800138000',
                        email: 'zhangsan@example.com',
                        notes: '公司员工',
                        passports: [
                            {
                                number: 'P1234567',
                                note: '因公护照',
                                status: 'in-stock', // in-stock, business, personal
                                lastOperation: null
                            },
                            {
                                number: 'P7654321',
                                note: '因私护照',
                                status: 'business',
                                lastOperation: {
                                    type: 'take',
                                    time: '2025-06-10T14:30:00',
                                    operator: '李四',
                                    notes: '出差使用'
                                }
                            }
                        ],
                        createdAt: '2025-06-01T10:00:00',
                        updatedAt: '2025-06-10T14:30:00'
                    },
                    {
                        id: generateId(),
                        name: '李四',
                        jobId: 'EMP002',
                        idNumber: '110101199102022345',
                        phone: '13900139000',
                        email: 'lisi@example.com',
                        notes: '公司员工',
                        passports: [
                            {
                                number: 'P2345678',
                                note: '因公护照',
                                status: 'in-stock',
                                lastOperation: null
                            }
                        ],
                        createdAt: '2025-06-02T11:00:00',
                        updatedAt: '2025-06-02T11:00:00'
                    },
                    {
                        id: generateId(),
                        name: '王五',
                        jobId: 'EMP003',
                        idNumber: '110101199203033456',
                        phone: '13700137000',
                        email: 'wangwu@example.com',
                        notes: '公司员工',
                        passports: [
                            {
                                number: 'P3456789',
                                note: '因公护照',
                                status: 'business',
                                lastOperation: {
                                    type: 'take',
                                    time: '2025-06-15T09:00:00',
                                    operator: '赵六',
                                    notes: '参加会议'
                                }
                            }
                        ],
                        createdAt: '2025-06-03T14:00:00',
                        updatedAt: '2025-06-15T09:00:00'
                    }
                ];
                savePersons();
            }
            
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            } else {
                // 添加示例历史记录
                history = [
                    {
                        id: generateId(),
                        time: '2025-06-01T10:00:00',
                        operator: '系统管理员',
                        type: 'add',
                        personId: persons[0].id,
                        personName: persons[0].name,
                        passportNumber: '',
                        notes: '添加人员信息及护照'
                    },
                    {
                        id: generateId(),
                        time: '2025-06-02T11:00:00',
                        operator: '系统管理员',
                        type: 'add',
                        personId: persons[1].id,
                        personName: persons[1].name,
                        passportNumber: '',
                        notes: '添加人员信息及护照'
                    },
                    {
                        id: generateId(),
                        time: '2025-06-03T14:00:00',
                        operator: '系统管理员',
                        type: 'add',
                        personId: persons[2].id,
                        personName: persons[2].name,
                        passportNumber: '',
                        notes: '添加人员信息及护照'
                    },
                    {
                        id: generateId(),
                        time: '2025-06-10T14:30:00',
                        operator: '李四',
                        type: 'take',
                        personId: persons[0].id,
                        personName: persons[0].name,
                        passportNumber: 'P7654321',
                        notes: '出差使用'
                    },
                    {
                        id: generateId(),
                        time: '2025-06-15T09:00:00',
                        operator: '赵六',
                        type: 'take',
                        personId: persons[2].id,
                        personName: persons[2].name,
                        passportNumber: 'P3456789',
                        notes: '参加会议'
                    }
                ];
                saveHistory();
            }
        }

        // 初始化图表
        function initializeChart() {
            const ctx = document.getElementById('passport-status-chart').getContext('2d');
            
            // 计算状态分布
            const statusCounts = calculateStatusCounts();
            
            passportStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['在库中', '业务办理', '本人领取'],
                    datasets: [{
                        data: [statusCounts.inStock, statusCounts.business, statusCounts.personal],
                        backgroundColor: [
                            '#10b981', // 绿色 - 在库中
                            '#f59e0b', // 黄色 - 业务办理
                            '#3b82f6'  // 蓝色 - 本人领取
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 计算状态分布
        function calculateStatusCounts() {
            let inStock = 0;
            let business = 0;
            let personal = 0;
            let multiplePassports = 0;
            
            persons.forEach(person => {
                const passportCount = person.passports.length;
                
                // 统计护照状态
                inStock += person.passports.filter(p => p.status === 'in-stock').length;
                business += person.passports.filter(p => p.status === 'business').length;
                personal += person.passports.filter(p => p.status === 'personal').length;
                
                // 统计多本护照人数
                if (passportCount > 1) {
                    multiplePassports++;
                }
            });
            
            return { inStock, business, personal, multiplePassports };
        }

        // 更新统计数据
        function updateStatistics() {
            // 更新卡片数据
            const totalPersons = persons.length;
            const inStockPersons = persons.filter(p => p.passports.every(pp => pp.status === 'in-stock')).length;
            const businessPersons = persons.filter(p => p.passports.some(pp => pp.status === 'business')).length;
            const personalPersons = persons.filter(p => p.passports.some(pp => pp.status === 'personal')).length;

            document.getElementById('total-persons').textContent = totalPersons;
            document.getElementById('in-stock-passports').textContent = inStockPersons;
            document.getElementById('business-passports').textContent = businessPersons;
            document.getElementById('personal-passports').textContent = personalPersons;
            
            // 更新图表
            if (passportStatusChart) {
                const statusCounts = calculateStatusCounts();
                passportStatusChart.data.datasets[0].data = [statusCounts.inStock, statusCounts.business, statusCounts.personal];
                passportStatusChart.update();
            }
        }

        // 渲染护照管理页面的人员列表
        function renderManagePersonTable(searchTerm = '') {
            let filteredPersons = persons;
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredPersons = filteredPersons.filter(person => 
                    person.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (person.jobId && person.jobId.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }

            // 按护照状态排序：业务办理和本人领取（已领取）在前，在库中在后
            filteredPersons.sort((a, b) => {
                const aInStockCount = a.passports.filter(p => p.status === 'in-stock').length;
                const aBusinessCount = a.passports.filter(p => p.status === 'business').length;
                const aPersonalCount = a.passports.filter(p => p.status === 'personal').length;
                
                const bInStockCount = b.passports.filter(p => p.status === 'in-stock').length;
                const bBusinessCount = b.passports.filter(p => p.status === 'business').length;
                const bPersonalCount = b.passports.filter(p => p.status === 'personal').length;

                const aTotalPassports = a.passports.length;
                const bTotalPassports = b.passports.length;

                // 如果A全部是业务办理或本人领取，B全部是在库中，则A排在前面
                if ((aBusinessCount + aPersonalCount === aTotalPassports) && (bInStockCount === bTotalPassports)) {
                    return -1;
                }
                // 如果B全部是业务办理或本人领取，A全部是在库中，则B排在前面
                if ((bBusinessCount + bPersonalCount === bTotalPassports) && (aInStockCount === aTotalPassports)) {
                    return 1;
                }
                // 如果A全部是业务办理，B全部是本人领取，则A排在前面
                if (aBusinessCount === aTotalPassports && bPersonalCount === bTotalPassports) {
                    return -1;
                }
                // 如果B全部是业务办理，A全部是本人领取，则B排在前面
                if (bBusinessCount === bTotalPassports && aPersonalCount === aTotalPassports) {
                    return 1;
                }
                // 其他情况，保持原有顺序
                return 0;
            });
            
            // 计算分页
            const startIndex = (manageCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedPersons = filteredPersons.slice(startIndex, endIndex);
            
            // 更新显示记录数
            document.getElementById('manage-showing-records').textContent = filteredPersons.length;
            
            // 更新分页按钮状态
            document.getElementById('manage-prev-page').disabled = manageCurrentPage === 1;
            document.getElementById('manage-next-page').disabled = endIndex >= filteredPersons.length;
            
            // 渲染表格内容
            const tableBody = document.getElementById('manage-person-table-body');
            tableBody.innerHTML = '';
            
            if (paginatedPersons.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">没有找到记录</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            paginatedPersons.forEach(person => {
                const passportCount = person.passports.length;
                const inStockCount = person.passports.filter(p => p.status === 'in-stock').length;
                const businessCount = person.passports.filter(p => p.status === 'business').length;
                const personalCount = person.passports.filter(p => p.status === 'personal').length;
                
                let status = '';
                let statusClass = '';
                
                if (inStockCount === passportCount) {
                    status = '全部在库中';
                    statusClass = 'status-in-stock';
                } else if (businessCount === passportCount) {
                    status = '全部业务办理';
                    statusClass = 'status-business';
                } else if (personalCount === passportCount) {
                    status = '全部本人领取';
                    statusClass = 'status-personal';
                } else {
                    // 混合状态
                    const statuses = [];
                    if (inStockCount > 0) statuses.push(`在库中(${inStockCount})`);
                    if (businessCount > 0) statuses.push(`业务办理(${businessCount})`);
                    if (personalCount > 0) statuses.push(`本人领取(${personalCount})`);
                    status = statuses.join(', ');
                    statusClass = 'status-business'; // 使用黄色作为混合状态的默认颜色
                }
                
                // 获取最近操作时间
                let lastOperationTime = person.updatedAt;
                if (lastOperationTime) {
                    lastOperationTime = formatDateTime(lastOperationTime);
                } else {
                    lastOperationTime = '-';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${person.name}</div>
                                <div class="text-sm text-gray-500">${person.idNumber || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${passportCount}</div>
                        <div class="text-xs text-gray-500">
                            ${person.passports.map(p => p.number).join(', ')}
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${lastOperationTime}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-primary hover:text-blue-800 manage-person-btn" data-person-id="${person.id}">管理</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // 添加管理按钮事件
            document.querySelectorAll('.manage-person-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const personId = this.getAttribute('data-person-id');
                    showPersonDetails(personId);
                });
            });
        }

        // 显示人员详情
        function showPersonDetails(personId) {
            // 查找人员
            const person = persons.find(p => p.id === personId);
            if (!person) {
                showToast('未找到该人员', 'error');
                return;
            }

            // 清空搜索框
            document.getElementById('manage-search').value = '';

            // 显示结果，隐藏列表
            document.getElementById('manage-person-result').classList.remove('hidden');
            document.getElementById('manage-no-result').classList.add('hidden');
            document.getElementById('manage-person-list').classList.add('hidden');
            
            // 填充人员信息
            document.getElementById('manage-person-name').textContent = person.name;
            document.getElementById('manage-person-id').textContent = person.jobId || '-';
            document.getElementById('manage-person-phone').textContent = person.phone || '-';
            document.getElementById('manage-person-email').textContent = person.email || '-';
            
            // 设置状态
            const passportCount = person.passports.length;
            const inStockCount = person.passports.filter(p => p.status === 'in-stock').length;
            const businessCount = person.passports.filter(p => p.status === 'business').length;
            const personalCount = person.passports.filter(p => p.status === 'personal').length;
            
            let status = '';
            let statusClass = '';
            
            if (inStockCount === passportCount) {
                status = '全部在库中';
                statusClass = 'status-in-stock';
            } else if (businessCount === passportCount) {
                status = '全部业务办理';
                statusClass = 'status-business';
            } else if (personalCount === passportCount) {
                status = '全部本人领取';
                statusClass = 'status-personal';
            } else {
                // 混合状态
                const statuses = [];
                if (inStockCount > 0) statuses.push(`在库中(${inStockCount})`);
                if (businessCount > 0) statuses.push(`业务办理(${businessCount})`);
                if (personalCount > 0) statuses.push(`本人领取(${personalCount})`);
                status = statuses.join(', ');
                statusClass = 'status-business'; // 使用黄色作为混合状态的默认颜色
            }
            
            const statusBadge = document.getElementById('manage-person-status');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            // 渲染护照列表
            renderPassportList(person);
            
            // 渲染操作记录
            renderOperationHistory(person.id);
        }

        // 渲染人员表格
        function renderPersonTable(filter = 'all', searchTerm = '') {
            let filteredPersons = persons;
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredPersons = filteredPersons.filter(person => 
                    person.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (person.jobId && person.jobId.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }
            
            // 应用状态过滤
            if (filter !== 'all') {
                filteredPersons = filteredPersons.filter(person => {
                    const statusCount = person.passports.filter(p => p.status === filter).length;
                    const passportCount = person.passports.length;
                    
                    return statusCount === passportCount;
                });
            }

            // 按护照状态排序：业务办理和本人领取（已领取）在前，在库中在后
            filteredPersons.sort((a, b) => {
                const aInStockCount = a.passports.filter(p => p.status === 'in-stock').length;
                const aBusinessCount = a.passports.filter(p => p.status === 'business').length;
                const aPersonalCount = a.passports.filter(p => p.status === 'personal').length;
                
                const bInStockCount = b.passports.filter(p => p.status === 'in-stock').length;
                const bBusinessCount = b.passports.filter(p => p.status === 'business').length;
                const bPersonalCount = b.passports.filter(p => p.status === 'personal').length;

                const aTotalPassports = a.passports.length;
                const bTotalPassports = b.passports.length;

                // 如果A全部是业务办理或本人领取，B全部是在库中，则A排在前面
                if ((aBusinessCount + aPersonalCount === aTotalPassports) && (bInStockCount === bTotalPassports)) {
                    return -1;
                }
                // 如果B全部是业务办理或本人领取，A全部是在库中，则B排在前面
                if ((bBusinessCount + bPersonalCount === bTotalPassports) && (aInStockCount === aTotalPassports)) {
                    return 1;
                }
                // 如果A全部是业务办理，B全部是本人领取，则A排在前面
                if (aBusinessCount === aTotalPassports && bPersonalCount === bTotalPassports) {
                    return -1;
                }
                // 如果B全部是业务办理，A全部是本人领取，则B排在前面
                if (bBusinessCount === bTotalPassports && aPersonalCount === aTotalPassports) {
                    return 1;
                }
                // 其他情况，保持原有顺序
                return 0;
            });
            
            // 计算分页
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedPersons = filteredPersons.slice(startIndex, endIndex);
            
            // 更新显示记录数
            document.getElementById('showing-records').textContent = filteredPersons.length;
            
            // 更新分页按钮状态
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = endIndex >= filteredPersons.length;
            
            // 渲染表格内容
            const tableBody = document.getElementById('person-table-body');
            tableBody.innerHTML = '';
            
            if (paginatedPersons.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">没有找到记录</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            paginatedPersons.forEach(person => {
                const passportCount = person.passports.length;
                const inStockCount = person.passports.filter(p => p.status === 'in-stock').length;
                const businessCount = person.passports.filter(p => p.status === 'business').length;
                const personalCount = person.passports.filter(p => p.status === 'personal').length;
                
                let status = '';
                let statusClass = '';
                
                if (inStockCount === passportCount) {
                    status = '全部在库中';
                    statusClass = 'status-in-stock';
                } else if (businessCount === passportCount) {
                    status = '全部业务办理';
                    statusClass = 'status-business';
                } else if (personalCount === passportCount) {
                    status = '全部本人领取';
                    statusClass = 'status-personal';
                } else {
                    // 混合状态
                    const statuses = [];
                    if (inStockCount > 0) statuses.push(`在库中(${inStockCount})`);
                    if (businessCount > 0) statuses.push(`业务办理(${businessCount})`);
                    if (personalCount > 0) statuses.push(`本人领取(${personalCount})`);
                    status = statuses.join(', ');
                    statusClass = 'status-business'; // 使用黄色作为混合状态的默认颜色
                }
                
                // 获取最近操作时间
                let lastOperationTime = person.updatedAt;
                if (lastOperationTime) {
                    lastOperationTime = formatDateTime(lastOperationTime);
                } else {
                    lastOperationTime = '-';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${person.name}</div>
                                <div class="text-sm text-gray-500">${person.idNumber || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${passportCount}</div>
                        <div class="text-xs text-gray-500">
                            ${person.passports.map(p => p.number).join(', ')}
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">${status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${lastOperationTime}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button class="text-primary hover:text-blue-800 mr-3 manage-person" data-id="${person.id}">管理</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 添加管理按钮事件
            document.querySelectorAll('.manage-person').forEach(button => {
                button.addEventListener('click', function() {
                    const personId = this.getAttribute('data-id');
                    navigateTo('manage-passport');
                    
                    // 填充搜索框并触发搜索
                    const person = persons.find(p => p.id === personId);
                    if (person) {
                        document.getElementById('manage-search').value = person.name;
                        searchPerson();
                    }
                });
            });
        }

        // 渲染历史记录
        function renderHistoryTable(searchTerm = '', operationType = 'all', dateRange = 30) {
            let filteredHistory = [...history];
            
            // 应用日期范围过滤
            if (dateRange !== 'all') {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateRange);
                
                filteredHistory = filteredHistory.filter(record => {
                    const recordDate = new Date(record.time);
                    return recordDate >= cutoffDate;
                });
            }
            
            // 应用操作类型过滤
            if (operationType !== 'all') {
                filteredHistory = filteredHistory.filter(record => record.type === operationType);
            }
            
            // 应用搜索过滤
            if (searchTerm) {
                filteredHistory = filteredHistory.filter(record => 
                    record.personName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    record.passportNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    record.operator.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            // 按时间降序排序
            filteredHistory.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            // 计算分页
            const startIndex = (historyPage - 1) * historyItemsPerPage;
            const endIndex = startIndex + historyItemsPerPage;
            const paginatedHistory = filteredHistory.slice(startIndex, endIndex);
            
            // 更新显示记录数
            document.getElementById('history-showing-records').textContent = filteredHistory.length;
            
            // 更新分页按钮状态
            document.getElementById('history-prev-page').disabled = historyPage === 1;
            document.getElementById('history-next-page').disabled = endIndex >= filteredHistory.length;
            
            // 渲染表格内容
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = '';
            
            if (paginatedHistory.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">没有找到记录</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            paginatedHistory.forEach(record => {
                let operationText = '';
                let operationClass = '';
                
                switch (record.type) {
                    case 'add':
                        operationText = '添加人员';
                        operationClass = 'text-green-600';
                        break;
                    case 'take':
                        operationText = '领取护照';
                        operationClass = 'text-red-600';
                        break;
                    case 'return':
                        operationText = '归还护照';
                        operationClass = 'text-blue-600';
                        break;
                    case 'delete':
                        operationText = '删除护照';
                        operationClass = 'text-red-600';
                        break;
                    default:
                        operationText = record.type;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDateTime(record.time)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.operator}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${operationClass}">
                            ${operationText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.personName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.passportNumber || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.notes || '-'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 设置导航
        function setupNavigation() {
            // 桌面端导航
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    navigateTo(target);
                });
            });
            
            // 移动端导航
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = this.getAttribute('data-target');
                    navigateTo(target);
                    closeMobileMenu();
                });
            });
        }

        // 按状态筛选
        function filterByStatus(status) {
            currentPage = 1;
            document.getElementById('status-filter').value = status;
            renderPersonTable(status, '');
        }

        // 导航到指定部分
        function navigateTo(target) {
            // 更新活动链接
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('data-target') === target) {
                    link.classList.add('active', 'bg-gray-700', 'text-white');
                    link.classList.remove('text-gray-300');
                } else {
                    link.classList.remove('active', 'bg-gray-700', 'text-white');
                    link.classList.add('text-gray-300');
                }
            });
            
            // 更新移动端活动链接
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                if (link.getAttribute('data-target') === target) {
                    link.classList.add('bg-gray-700', 'text-white');
                    link.classList.remove('text-gray-300');
                } else {
                    link.classList.remove('bg-gray-700', 'text-white');
                    link.classList.add('text-gray-300');
                }
            });
            
            // 显示目标部分，隐藏其他部分
            document.querySelectorAll('.content-section').forEach(section => {
                if (section.id === target) {
                    section.classList.remove('hidden');
                    section.classList.add('active');
                } else {
                    section.classList.add('hidden');
                    section.classList.remove('active');
                }
            });
            
            // 更新移动端标题
            document.getElementById('mobile-title').textContent = getSectionTitle(target);

            // 如果切换到护照管理页面，初始化人员列表
            if (target === 'manage-passport') {
                manageCurrentPage = 1;
                renderManagePersonTable();
            }
        }

        // 获取部分标题
        function getSectionTitle(target) {
            switch (target) {
                case 'dashboard':
                    return '数据概览';
                case 'add-person':
                    return '添加人员';
                case 'manage-passport':
                    return '护照管理';
                case 'history':
                    return '历史记录';
                default:
                    return '护照管理系统';
            }
        }

        // 设置移动端菜单
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuContent = document.getElementById('mobile-menu-content');
            const closeMobileMenuButton = document.getElementById('close-mobile-menu');
            
            mobileMenuButton.addEventListener('click', function() {
                mobileMenu.classList.remove('hidden');
                setTimeout(() => {
                    mobileMenuContent.classList.remove('-translate-x-full');
                }, 10);
            });
            
            closeMobileMenuButton.addEventListener('click', closeMobileMenu);
            
            mobileMenu.addEventListener('click', function(e) {
                if (e.target === mobileMenu) {
                    closeMobileMenu();
                }
            });
        }

        // 关闭移动端菜单
        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileMenuContent = document.getElementById('mobile-menu-content');
            
            mobileMenuContent.classList.add('-translate-x-full');
            setTimeout(() => {
                mobileMenu.classList.add('hidden');
            }, 300);
        }

        // 设置表单事件
        function setupForms() {
            // 添加人员表单
            const addPersonForm = document.getElementById('add-person-form');
            addPersonForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addPerson();
            });
            
            // 取消添加人员
            document.getElementById('cancel-add-person').addEventListener('click', function() {
                navigateTo('dashboard');
            });
            
            // 添加护照按钮
            document.getElementById('add-passport').addEventListener('click', addPassportField);
            
            // 护照操作表单
            const passportActionForm = document.getElementById('passport-action-form');
            passportActionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitPassportAction();
            });
            
            // 取消模态框
            document.getElementById('cancel-modal').addEventListener('click', closeModal);
            document.getElementById('close-modal').addEventListener('click', closeModal);
            
            // Excel文件上传
            const excelFileInput = document.getElementById('excel-file');
            excelFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    parseExcelFile(file);
                }
            });
        }
        
        // 解析Excel文件
        function parseExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showToast('Excel文件至少需要包含表头和一条数据', 'error');
                        return;
                    }
                    
                    // 跳过表头，处理数据行
                    let successCount = 0;
                    let errorCount = 0;
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        const jobId = row[0];
                        const name = row[1];
                        const passportNumber = row[2];
                        let status = row[3] ? row[3].toString().trim().toLowerCase() : 'in-stock';
                        
                        // 验证状态值，确保其为有效的状态
                        const validStatuses = ['in-stock', 'business', 'personal'];
                        if (!validStatuses.includes(status)) {
                            status = 'in-stock';
                        }
                        
                        // 验证数据
                        if (name && passportNumber) {
                            // 检查是否已存在该人员（通过工号或姓名）
                            const existingPerson = persons.find(p => p.jobId === jobId || p.name === name);
                            
                            if (existingPerson) {
                                // 检查是否已存在该护照号
                                const existingPassport = existingPerson.passports.find(p => p.number === passportNumber);
                                
                                if (!existingPassport) {
                                    // 添加新护照
                                    existingPerson.passports.push({
                                        number: passportNumber,
                                        note: '',
                                        status: status,
                                        lastOperation: null
                                    });
                                    existingPerson.updatedAt = new Date().toISOString();
                                    successCount++;
                                } else {
                                    errorCount++;
                                }
                            } else {
                                // 创建新人员
                                const now = new Date().toISOString();
                                const newPerson = {
                                    id: generateId(),
                                    jobId,
                                    name,
                                    idNumber: '',
                                    phone: '',
                                    email: '',
                                    notes: '',
                                    passports: [{
                                        number: passportNumber,
                                        note: '',
                                        status: status,
                                        lastOperation: null
                                    }],
                                    createdAt: now,
                                    updatedAt: now
                                };
                                
                                persons.push(newPerson);
                                addHistoryRecord('add', newPerson.id, newPerson.name, passportNumber, '批量导入');
                                successCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    }
                    
                    // 保存数据
                    savePersons();
                    
                    // 更新统计数据和表格
                    updateStatistics();
                    renderPersonTable();
                    
                    // 显示提示
                    showToast(`成功导入 ${successCount} 条记录，${errorCount} 条记录失败`);
                    
                    // 清空文件输入
                    document.getElementById('excel-file').value = '';
                    
                } catch (error) {
                    console.error('解析Excel文件时出错:', error);
                    showToast('解析Excel文件时出错，请检查文件格式', 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('读取文件时出错', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 添加护照字段
        function addPassportField() {
            const container = document.getElementById('passport-container');
            const passportCount = container.querySelectorAll('.passport-item').length;
            
            const passportItem = document.createElement('div');
            passportItem.className = 'passport-item border border-gray-200 rounded-lg p-4 mb-4';
            passportItem.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-md font-medium text-gray-800">护照 ${passportCount + 1}</h4>
                    <button type="button" class="remove-passport text-red-500 hover:text-red-700">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">护照号 <span class="text-red-500">*</span></label>
                        <input type="text" name="passportNumbers[]" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">备注</label>
                        <input type="text" name="passportNotes[]" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
            `;
            
            container.appendChild(passportItem);
            
            // 添加删除按钮事件
            passportItem.querySelector('.remove-passport').addEventListener('click', function() {
                passportItem.remove();
                updatePassportNumbers();
            });
        }

        // 更新护照编号
        function updatePassportNumbers() {
            const passportItems = document.querySelectorAll('.passport-item');
            passportItems.forEach((item, index) => {
                item.querySelector('h4').textContent = `护照 ${index + 1}`;
            });
        }

        // 添加人员
        function addPerson() {
            const formData = new FormData(document.getElementById('add-person-form'));
            
            // 获取表单数据
            const name = formData.get('name');
            const jobId = formData.get('jobId');
            const idNumber = formData.get('idNumber');
            const phone = formData.get('phone');
            const email = formData.get('email');
            const notes = formData.get('notes');
            
            // 获取护照数据
            const passportNumbers = formData.getAll('passportNumbers[]');
            const passportNotes = formData.getAll('passportNotes[]');
            
            // 创建护照数组
            const passports = passportNumbers.map((number, index) => ({
                number,
                note: passportNotes[index] || '',
                status: 'available',
                lastOperation: null
            }));
            
            // 创建人员对象
            const now = new Date().toISOString();
            const person = {
                id: generateId(),
                name,
                jobId,
                idNumber,
                phone,
                email,
                notes,
                passports,
                createdAt: now,
                updatedAt: now
            };
            
            // 添加到人员数组
            persons.push(person);
            
            // 保存数据
            savePersons();
            
            // 添加历史记录
            addHistoryRecord('add', person.id, person.name, '', '添加人员信息及护照');
            
            // 重置表单
            document.getElementById('add-person-form').reset();
            
            // 更新统计数据和表格
            updateStatistics();
            renderPersonTable();
            
            // 显示提示
            showToast('人员添加成功');
            
            // 导航到数据概览
            navigateTo('dashboard');
        }

        // 设置搜索事件
        function setupSearch() {
            // 顶部搜索
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                const statusFilter = document.getElementById('status-filter').value;
                
                currentPage = 1;
                // 确保在护照管理页面
                if (document.getElementById('dashboard').classList.contains('hidden')) {
                    navigateTo('dashboard');
                }
                renderPersonTable(statusFilter, searchTerm);
            });
            
            // 为每页显示条数选择框添加事件监听
            const itemsPerPageSelect = document.getElementById('items-per-page');
            if (itemsPerPageSelect) {
                itemsPerPageSelect.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 1;
                    renderPersonTable();
                });
            }

            // 刷新列表按钮
            document.getElementById('refresh-list-btn').addEventListener('click', function() {
                currentPage = 1;
                renderPersonTable();
                showToast('列表已更新');
            });

            // 状态筛选
            const statusFilter = document.getElementById('status-filter');
            statusFilter.addEventListener('change', function() {
                const filter = this.value;
                const searchTerm = document.getElementById('search-input').value.trim();
                
                currentPage = 1;
                renderPersonTable(filter, searchTerm);
            });
            
            // 护照管理搜索
            document.getElementById('search-person-btn').addEventListener('click', searchPerson);

            // 护照管理页面分页
            document.getElementById('manage-prev-page').addEventListener('click', function() {
                if (manageCurrentPage > 1) {
                    manageCurrentPage--;
                    renderManagePersonTable();
                }
            });

            document.getElementById('manage-next-page').addEventListener('click', function() {
                manageCurrentPage++;
                renderManagePersonTable();
            });
            
            // 历史记录搜索
            document.getElementById('history-search-btn').addEventListener('click', function() {
                const searchTerm = document.getElementById('history-search').value.trim();
                const operationType = document.getElementById('history-operation').value;
                const dateRange = document.getElementById('history-date-range').value;
                
                historyPage = 1;
                renderHistoryTable(searchTerm, operationType, dateRange);
            });
        }

        // 搜索人员
        function searchPerson() {
            const searchTerm = document.getElementById('manage-search').value.trim();
            
            if (!searchTerm) {
                document.getElementById('manage-person-result').classList.add('hidden');
                document.getElementById('manage-no-result').classList.add('hidden');
                document.getElementById('manage-person-list').classList.remove('hidden');
                return;
            }
            
            // 搜索人员
            const person = persons.find(p => p.name.toLowerCase() === searchTerm.toLowerCase());
            
            if (person) {
                // 显示结果，隐藏列表
                document.getElementById('manage-person-result').classList.remove('hidden');
                document.getElementById('manage-no-result').classList.add('hidden');
                document.getElementById('manage-person-list').classList.add('hidden');
                
                // 填充人员信息
                document.getElementById('manage-person-name').textContent = person.name;
                document.getElementById('manage-person-id').textContent = person.jobId || '-';
                document.getElementById('manage-person-phone').textContent = person.phone || '-';
                document.getElementById('manage-person-email').textContent = person.email || '-';
                
                // 设置状态
                const passportCount = person.passports.length;
                const inStockCount = person.passports.filter(p => p.status === 'in-stock').length;
                const businessCount = person.passports.filter(p => p.status === 'business').length;
                const personalCount = person.passports.filter(p => p.status === 'personal').length;
                
                let status = '';
                let statusClass = '';
                
                if (inStockCount === passportCount) {
                    status = '全部在库中';
                    statusClass = 'status-in-stock';
                } else if (businessCount === passportCount) {
                    status = '全部业务办理';
                    statusClass = 'status-business';
                } else if (personalCount === passportCount) {
                    status = '全部本人领取';
                    statusClass = 'status-personal';
                } else {
                    // 混合状态
                    const statuses = [];
                    if (inStockCount > 0) statuses.push(`在库中(${inStockCount})`);
                    if (businessCount > 0) statuses.push(`业务办理(${businessCount})`);
                    if (personalCount > 0) statuses.push(`本人领取(${personalCount})`);
                    status = statuses.join(', ');
                    statusClass = 'status-business'; // 使用黄色作为混合状态的默认颜色
                }
                
                const statusBadge = document.getElementById('manage-person-status');
                statusBadge.textContent = status;
                statusBadge.className = `status-badge ${statusClass}`;
                
                // 渲染护照列表
                renderPassportList(person);
                
                // 渲染操作记录
                renderOperationHistory(person.id);
            } else {
                document.getElementById('manage-person-result').classList.add('hidden');
                document.getElementById('manage-no-result').classList.remove('hidden');
                document.getElementById('manage-person-list').classList.add('hidden');
            }
        }

        // 渲染护照列表
        function renderPassportList(person) {
            const container = document.getElementById('passports-to-manage');
            container.innerHTML = '';
            
            person.passports.forEach((passport, index) => {
                const passportCard = document.createElement('div');
                passportCard.className = 'border border-gray-200 rounded-lg p-4 mb-4';
                
                let statusText = '';
                let statusClass = '';
                let actionButtonText = '';
                let actionButtonClass = '';
                let actionType = '';
                
                switch (passport.status) {
                    case 'in-stock':
                        statusText = '在库中';
                        statusClass = 'status-in-stock';
                        actionButtonText = '选择操作';
                        actionButtonClass = 'bg-blue-500 hover:bg-blue-600';
                        actionType = 'select';
                        break;
                    case 'business':
                        statusText = '业务办理';
                        statusClass = 'status-business';
                        actionButtonText = '归还';
                        actionButtonClass = 'bg-green-500 hover:bg-green-600';
                        actionType = 'return';
                        break;
                    case 'personal':
                        statusText = '本人领取';
                        statusClass = 'status-personal';
                        actionButtonText = '归还';
                        actionButtonClass = 'bg-green-500 hover:bg-green-600';
                        actionType = 'return';
                        break;
                    default:
                        statusText = '未知状态';
                        statusClass = 'status-business';
                        actionButtonText = '更新状态';
                        actionButtonClass = 'bg-gray-500 hover:bg-gray-600';
                        actionType = 'update';
                }
                
                passportCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center">
                                <h4 class="text-md font-medium text-gray-800">${passport.number}</h4>
                                <span class="status-badge ${statusClass} ml-2">${statusText}</span>
                            </div>
                            ${passport.note ? `<p class="text-sm text-gray-600 mt-1">${passport.note}</p>` : ''}
                            ${passport.lastOperation ? `
                                <div class="mt-2 text-sm text-gray-500">
                                    <p><span class="font-medium">最近操作：</span>${passport.lastOperation.type === 'take' ? '领取' : '归还'}</p>
                                    <p><span class="font-medium">操作时间：</span>${formatDateTime(passport.lastOperation.time)}</p>
                                    <p><span class="font-medium">操作人：</span>${passport.lastOperation.operator}</p>
                                    ${passport.lastOperation.notes ? `<p><span class="font-medium">备注：</span>${passport.lastOperation.notes}</p>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button class="passport-action-btn px-3 py-1 text-white rounded-lg ${actionButtonClass}" 
                                data-person-id="${person.id}" 
                                data-passport-index="${index}" 
                                data-action-type="${actionType}">
                                ${actionButtonText}
                            </button>
                            <button class="passport-action-btn px-3 py-1 text-white rounded-lg bg-red-500 hover:bg-red-600" 
                                data-person-id="${person.id}" 
                                data-passport-index="${index}" 
                                data-action-type="delete">
                                删除
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(passportCard);
            });
            
            // 添加操作按钮事件
            document.querySelectorAll('.passport-action-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const personId = this.getAttribute('data-person-id');
                    const passportIndex = parseInt(this.getAttribute('data-passport-index'));
                    const actionType = this.getAttribute('data-action-type');
                    
                    openPassportActionModal(personId, passportIndex, actionType);
                });
            });

            // 添加删除按钮事件
            const deleteButtons = document.querySelectorAll('.delete-passport-btn');
            console.log('删除按钮数量:', deleteButtons.length);
            deleteButtons.forEach(button => {
                console.log('绑定删除按钮事件');
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    console.log('点击了删除按钮');
                    const personId = this.getAttribute('data-person-id');
                    const passportIndex = parseInt(this.getAttribute('data-passport-index'));
                    console.log('删除护照:', personId, passportIndex);
                    
                    // 弹出确认对话框
                    if (confirm('确定要删除这本护照吗？此操作无法撤销。')) {
                        deletePassport(personId, passportIndex);
                    }
                });
            });
        }

        // 删除护照
        function deletePassport(personId, passportIndex) {
            const personIndex = persons.findIndex(p => p.id === personId);
            if (personIndex === -1) {
                showToast('未找到该人员', 'error');
                return;
            }

            const person = persons[personIndex];
            if (passportIndex < 0 || passportIndex >= person.passports.length) {
                showToast('未找到该护照', 'error');
                return;
            }

            const passportToDelete = person.passports[passportIndex];

            // 从人员的护照数组中删除该护照
            person.passports.splice(passportIndex, 1);
            person.updatedAt = new Date().toISOString();

            // 如果人员没有护照了，删除该人员
            if (person.passports.length === 0) {
                persons.splice(personIndex, 1);
                addHistoryRecord('delete', personId, person.name, passportToDelete.number, '删除人员及护照');
            } else {
                addHistoryRecord('delete', personId, person.name, passportToDelete.number, '删除护照');
            }

            // 保存数据
            savePersons();
            saveHistory();

            // 更新统计数据和表格
            updateStatistics();
            
            // 如果当前在护照管理页面，重新渲染护照列表
            if (document.getElementById('manage-passport').classList.contains('active')) {
                // 返回搜索框所在的页面
                document.getElementById('manage-person-result').classList.add('hidden');
                document.getElementById('manage-no-result').classList.add('hidden');
                document.getElementById('manage-person-list').classList.remove('hidden');
                renderManagePersonTable();
            }

            // 显示提示
            showToast('护照删除成功');
        }

        // 渲染操作记录
        function renderOperationHistory(personId) {
            // 筛选该人员的操作记录
            const personHistory = history.filter(record => record.personId === personId);
            
            // 按时间降序排序
            personHistory.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            // 限制显示最近5条记录
            const recentHistory = personHistory.slice(0, 5);
            
            const tableBody = document.getElementById('operation-history');
            tableBody.innerHTML = '';
            
            if (recentHistory.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">没有操作记录</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            recentHistory.forEach(record => {
                let operationText = '';
                let operationClass = '';
                
                switch (record.type) {
                    case 'add':
                        operationText = '添加人员';
                        operationClass = 'text-green-600';
                        break;
                    case 'take':
                        operationText = '领取护照';
                        operationClass = 'text-red-600';
                        break;
                    case 'return':
                        operationText = '归还护照';
                        operationClass = 'text-blue-600';
                        break;
                    case 'delete':
                        operationText = '删除护照';
                        operationClass = 'text-red-600';
                        break;
                    default:
                        operationText = record.type;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDateTime(record.time)}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${operationClass}">
                            ${operationText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.passportNumber || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${record.operator}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${record.notes || '-'}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 设置分页事件
        function setupPagination() {
            // 人员表格分页
            document.getElementById('prev-page').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    const searchTerm = document.getElementById('search-input').value.trim();
                    const statusFilter = document.getElementById('status-filter').value;
                    renderPersonTable(statusFilter, searchTerm);
                }
            });
            
            document.getElementById('next-page').addEventListener('click', function() {
                currentPage++;
                const searchTerm = document.getElementById('search-input').value.trim();
                const statusFilter = document.getElementById('status-filter').value;
                renderPersonTable(statusFilter, searchTerm);
            });
            
            // 历史记录分页
            document.getElementById('history-prev-page').addEventListener('click', function() {
                if (historyPage > 1) {
                    historyPage--;
                    const searchTerm = document.getElementById('history-search').value.trim();
                    const operationType = document.getElementById('history-operation').value;
                    const dateRange = document.getElementById('history-date-range').value;
                    renderHistoryTable(searchTerm, operationType, dateRange);
                }
            });
            
            document.getElementById('history-next-page').addEventListener('click', function() {
                historyPage++;
                const searchTerm = document.getElementById('history-search').value.trim();
                const operationType = document.getElementById('history-operation').value;
                const dateRange = document.getElementById('history-date-range').value;
                renderHistoryTable(searchTerm, operationType, dateRange);
            });
        }

        // 设置模态框
        function setupModal() {
            const modal = document.getElementById('passport-action-modal');
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // 打开护照操作模态框
        function openPassportActionModal(personId, passportIndex, actionType) {
            const person = persons.find(p => p.id === personId);
            if (!person) return;
            
            const passport = person.passports[passportIndex];
            if (!passport) return;
            
            // 获取状态选择容器
            const statusSelectContainer = document.getElementById('modal-status-select-container');
            
            // 设置模态框标题和提交按钮
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('modal-submit-btn');
            
            if (actionType === 'select') {
                // 从"在库中"状态选择新状态
                modalTitle.textContent = '选择护照状态';
                submitBtn.textContent = '确认操作';
                submitBtn.className = 'px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600';
                
                // 显示状态选择容器
                statusSelectContainer.classList.remove('hidden');
            } else if (actionType === 'return') {
                // 归还护照（回到在库中状态）
                modalTitle.textContent = '归还护照';
                submitBtn.textContent = '确认归还';
                submitBtn.className = 'px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600';
                
                // 隐藏状态选择容器
                statusSelectContainer.classList.add('hidden');
            } else if (actionType === 'delete') {
                // 删除护照
                modalTitle.textContent = '删除护照';
                submitBtn.textContent = '确认删除';
                submitBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600';
                
                // 隐藏状态选择容器
                statusSelectContainer.classList.add('hidden');
            } else {
                // 更新状态
                modalTitle.textContent = '更新护照状态';
                submitBtn.textContent = '确认更新';
                submitBtn.className = 'px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600';
                
                // 显示状态选择容器
                statusSelectContainer.classList.remove('hidden');
            }
            
            // 填充表单数据
            document.getElementById('modal-person-id').value = personId;
            document.getElementById('modal-passport-index').value = passportIndex;
            document.getElementById('modal-action-type').value = actionType;
            document.getElementById('modal-person-name').value = person.name;
            document.getElementById('modal-passport-number').value = passport.number;
            
            // 设置当前时间
            const now = new Date();
            const dateTimeString = now.toISOString().slice(0, 16);
            document.getElementById('modal-action-time').value = dateTimeString;
            
            // 清空其他字段
            document.getElementById('modal-operator').value = '';
            document.getElementById('modal-notes').value = '';
            
            // 显示模态框
            document.getElementById('passport-action-modal').classList.remove('hidden');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('passport-action-modal').classList.add('hidden');
        }

        // 提交护照操作
        function submitPassportAction() {
            const personId = document.getElementById('modal-person-id').value;
            const passportIndex = parseInt(document.getElementById('modal-passport-index').value);
            const actionType = document.getElementById('modal-action-type').value;
            const actionTime = document.getElementById('modal-action-time').value;
            const operator = document.getElementById('modal-operator').value;
            const notes = document.getElementById('modal-notes').value;
            
            // 查找人员
            const personIndex = persons.findIndex(p => p.id === personId);
            if (personIndex === -1) {
                showToast('人员不存在', 'error');
                return;
            }
            
            const person = persons[personIndex];
            const passport = person.passports[passportIndex];
            if (!passport) {
                showToast('护照不存在', 'error');
                return;
            }
            
            let newStatus = passport.status;
            let historyActionType = actionType;
            
            // 根据操作类型执行不同的操作
            if (actionType === 'delete') {
                // 删除护照
                deletePassport(personId, passportIndex);
                closeModal();
                return;
            } else if (actionType === 'select' || actionType === 'update') {
                // 从下拉框获取选择的状态
                newStatus = document.getElementById('modal-status-select').value;
                historyActionType = newStatus; // 使用新状态作为历史记录的操作类型
            } else if (actionType === 'return') {
                // 归还护照，回到在库中状态
                newStatus = 'in-stock';
            }
            
            // 更新护照状态
            passport.status = newStatus;
            passport.lastOperation = {
                type: historyActionType,
                time: new Date(actionTime).toISOString(),
                operator: operator || '', // 如果未填写操作人，则为空字符串
                notes
            };
            
            // 更新人员更新时间
            person.updatedAt = new Date(actionTime).toISOString();
            
            // 保存数据
            savePersons();
            
            // 添加历史记录
            addHistoryRecord(historyActionType, personId, person.name, passport.number, notes);
            
            // 更新统计数据和表格
            updateStatistics();
            
            // 如果当前在护照管理页面，返回搜索框所在的页面
            if (document.getElementById('manage-passport').classList.contains('active')) {
                document.getElementById('manage-person-result').classList.add('hidden');
                document.getElementById('manage-no-result').classList.add('hidden');
                document.getElementById('manage-person-list').classList.remove('hidden');
                renderManagePersonTable();
            } else {
                // 否则更新人员表格
                const searchTerm = document.getElementById('search-input').value.trim();
                const statusFilter = document.getElementById('status-filter').value;
                renderPersonTable(statusFilter, searchTerm);
            }
            
            // 关闭模态框
            closeModal();
            
            // 显示提示
            let toastMessage = '';
            switch (newStatus) {
                case 'in-stock':
                    toastMessage = '护照已归还到库中';
                    break;
                case 'business':
                    toastMessage = '护照已标记为业务办理';
                    break;
                case 'personal':
                    toastMessage = '护照已标记为本人领取';
                    break;
                default:
                    toastMessage = '护照状态更新成功';
            }
            showToast(toastMessage);
        }

        // 添加历史记录
        function addHistoryRecord(type, personId, personName, passportNumber, notes) {
            const record = {
                id: generateId(),
                time: new Date().toISOString(),
                operator: '0', // 默认操作人为0
                type,
                personId,
                personName,
                passportNumber,
                notes
            };
            
            history.push(record);
            saveHistory();
            
            // 如果当前在历史记录页面，重新渲染
            if (document.getElementById('history').classList.contains('active')) {
                const searchTerm = document.getElementById('history-search').value.trim();
                const operationType = document.getElementById('history-operation').value;
                const dateRange = document.getElementById('history-date-range').value;
                renderHistoryTable(searchTerm, operationType, dateRange);
            }
        }

        // 设置导出功能
        function setupExport() {
            document.getElementById('export-data').addEventListener('click', exportData);
        }

        // 导出数据
        function exportData() {
            // 创建导出数据对象
            const exportData = {
                persons,
                history,
                exportTime: new Date().toISOString(),
                version: '1.0'
            };
            
            // 转换为JSON字符串
            const jsonString = JSON.stringify(exportData, null, 2);
            
            // 创建Blob对象
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // 创建下载链接
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `护照管理数据_${formatDate(new Date())}.json`;
            
            // 触发下载
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            
            // 添加历史记录
            addHistoryRecord('export', '', '', '', '导出数据');
            
            // 显示提示
            showToast('数据导出成功');
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // 设置消息内容
            toastMessage.textContent = message;
            
            // 设置样式
            if (type === 'success') {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
                toast.querySelector('i').className = 'fa fa-check-circle mr-2';
            } else {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
                toast.querySelector('i').className = 'fa fa-exclamation-circle mr-2';
            }
            
            // 显示提示
            toast.classList.remove('translate-y-10', 'opacity-0');
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
            }, 3000);
        }

        // 保存人员数据到localStorage
        function savePersons() {
            localStorage.setItem('passportManagementPersons', JSON.stringify(persons));
            
            // 如果当前在数据概览页面，自动更新人员列表
            if (document.getElementById('dashboard').classList.contains('active')) {
                renderPersonTable();
            }
        }

        // 保存历史记录到localStorage
        function saveHistory() {
            localStorage.setItem('passportManagementHistory', JSON.stringify(history));
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return `${formatDate(date)} ${formatTime(date)}`;
        }

        // 格式化日期
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 格式化时间
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
    </script>
</body>
</html>